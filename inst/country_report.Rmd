---
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(patchwork)
library(tidyr)
library(gf)
iso <- unique(gf_optimised$ISO)
country <- unique(gf_optimised$NAME_0)
gf_optimised$budget_prop = factor(gf_optimised$budget_prop)
```

# Global Fund country report for `r country` (`r iso`)
### Date: `r format(Sys.time(), "%d/%m/%y")`

\    
\    

## GTS comparions check

```{r, echo = FALSE, fig.height = 4, fig.width = 6, message = FALSE}
gf_global_plan <- gf_gp %>%
  select(year, cases) %>%
  mutate(run = "GF global plan")
gts_global_plan <- gts_gp %>%
  filter(Scenario == "Accelerate2as") %>%
  select(year, cases) %>%
  mutate(run = "GTS global plan")
gts_gf <- bind_rows(gf_global_plan, gts_global_plan)

ggplot(gts_gf, aes(x = year, y = cases, col = run)) +
  geom_line() +
  theme_bw()
```

\newpage

## Interventions

```{r, echo = FALSE, fig.height = 4, fig.width = 6, message = FALSE}
interventions_budget_prop <- gf_optimised %>%
  select(year, pre, budget_prop, post, par,
         treatment_coverage, net_coverage, irs_coverage, smc_coverage, ipti_coverage, rtss_coverage) %>%
  filter(year %in% 2024:2026) %>%
  select(-year) %>%
  group_by(pre, budget_prop, post) %>%
  pivot_longer(-c(pre, budget_prop, post, par), names_to = "intervention", values_to = "coverage") %>%
  mutate(intervention = factor(intervention, 
                               levels = c("treatment_coverage",
                                          "net_coverage",
                                          "irs_coverage",
                                          "smc_coverage",
                                          "ipti_coverage",
                                          "rtss_coverage"),
                               labels = c("Treatment",
                                          "Nets",
                                          "IRS", 
                                          "SMC",
                                          "IPTi",
                                          "RTS,S"))) %>%
  group_by(pre, budget_prop, post, intervention) %>%
  summarise(coverage = weighted.mean(coverage, par)) %>%
  mutate(budget_prop = factor(budget_prop))

interventions_replenishment <- ggplot(interventions_budget_prop, aes(x = budget_prop, y = coverage, fill = intervention)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_discrete(name = "") +
  xlab("Proportion of global plan budget") +
  ylab("Effective coverage") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

print(interventions_replenishment)

```

\newpage

## Cases
```{r, echo = FALSE, fig.height = 7, fig.width = 5, message = FALSE}
cumulative_case_data <- gf_optimised %>%
  filter(year >= 2019) %>%
  group_by(pre, budget_prop, post) %>%
  arrange(year, .by_group = TRUE) %>%
  mutate(cumulative_cases = cumsum(cases))

cumulative_cases <- ggplot(cumulative_case_data, aes(x = year, y = cumulative_cases / 1e6, col = budget_prop)) + 
  geom_line() +
  scale_colour_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Year") +
  ylab("Cumulative cases \n(millions, since 2019)") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

case_data <- gf_optimised %>%
  filter(year >= 2016)

who <- who_burden %>%
  filter(ISO == iso, year %in% 2016:2018)

case_time_series <- ggplot() + 
  geom_line(data = case_data, aes(x = year, y = cases / 1e6, col = budget_prop)) +
  geom_point(data = who, aes(x = year, y = cases / 1e6), col = "red") +
  scale_colour_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Year") +
  ylab("Cases (millions)") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

cases_budget_prop <- gf_optimised %>%
  filter(year %in% 2024:2026) %>%
  group_by(pre, budget_prop, post) %>%
  summarise(cases = sum(cases),
            cases_lower = sum(cases_lower),
            cases_upper = sum(cases_upper))

cases_replenishment <- ggplot(cases_budget_prop, aes(x = budget_prop, y = cases / 1e6, fill = budget_prop, ymin = cases_lower / 1e6, ymax = cases_upper / 1e6)) +
  geom_bar(stat = "identity") +
  geom_linerange() +
  scale_fill_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Proportion of global plan budget") +
  ylab("Total cases (millions) during \nreplenishment period") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

cases_increase_budget_prop <- cases_budget_prop
cases_increase_budget_prop$cases = cases_increase_budget_prop$cases - cases_increase_budget_prop$cases[cases_increase_budget_prop$budget_prop == 1]
cases_increase_budget_prop$cases_lower = cases_increase_budget_prop$cases_lower - cases_increase_budget_prop$cases_lower[cases_increase_budget_prop$budget_prop == 1]
cases_increase_budget_prop$cases_upper = cases_increase_budget_prop$cases_upper - cases_increase_budget_prop$cases[cases_increase_budget_prop$budget_prop == 1]

cases_increase_replenishment <- ggplot(cases_increase_budget_prop, aes(x = budget_prop, y = cases / 1e6, fill = budget_prop, ymin = cases_lower / 1e6, ymax = cases_upper / 1e6)) +
  geom_bar(stat = "identity") +
  geom_linerange() +
  scale_fill_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Proportion of global plan budget") +
  ylab("Increase in cases (millions) vs budget_prop = 1") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

print(cumulative_cases / case_time_series / cases_replenishment / cases_increase_replenishment)

```

\newpage

## Deaths
```{r, echo = FALSE, fig.height = 7, fig.width = 5, message = FALSE}
cumulative_death_data <- gf_optimised %>%
  filter(year >= 2019) %>%
  group_by(pre, budget_prop, post) %>%
  arrange(year, .by_group = TRUE) %>%
  mutate(cumulative_deaths = cumsum(deaths))

cumulative_deaths <- ggplot(cumulative_death_data, aes(x = year, y = cumulative_deaths / 1000, col = budget_prop)) + 
  geom_line() +
  scale_colour_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Year") +
  ylab("Cumulative deaths \n(thousands, since 2019)") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

death_data <- gf_optimised %>%
  filter(year >= 2016)

death_time_series <- ggplot() + 
  geom_line(data = death_data, aes(x = year, y = deaths / 1000, col = budget_prop)) +
  scale_colour_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Year") +
  ylab("deaths (thousands)") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

deaths_budget_prop <- gf_optimised %>%
  filter(year %in% 2024:2026) %>%
  group_by(pre, budget_prop, post) %>%
  summarise(deaths = sum(deaths),
            deaths_lower = sum(deaths_lower),
            deaths_upper = sum(deaths_upper))

deaths_replenishment <- ggplot(deaths_budget_prop, aes(x = budget_prop, y = deaths / 1000, fill = budget_prop, ymin = deaths_lower / 1000, ymax = deaths_upper / 1000)) +
  geom_bar(stat = "identity") +
  geom_linerange() +
  scale_fill_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Proportion of global plan budget") +
  ylab("Total deaths (thousands) during \nreplenishment period") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

print(cumulative_deaths / death_time_series / deaths_replenishment)

```

\newpage

## DALYS
```{r, echo = FALSE, fig.height = 7, fig.width = 5, message = FALSE}
cumulative_daly_data <- gf_optimised %>%
  filter(year >= 2019) %>%
  group_by(pre, budget_prop, post) %>%
  arrange(year, .by_group = TRUE) %>%
  mutate(cumulative_dalys = cumsum(dalys))

cumulative_dalys <- ggplot(cumulative_daly_data, aes(x = year, y = cumulative_dalys, col = budget_prop)) + 
  geom_line() +
  scale_colour_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Year") +
  ylab("Cumulative dalys \n(millions, since 2019)") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

daly_data <- gf_optimised %>%
  filter(year >= 2016)

daly_time_series <- ggplot() + 
  geom_line(data = daly_data, aes(x = year, y = dalys / 1e6, col = budget_prop)) +
  scale_colour_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Year") +
  ylab("dalys (millions)") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

dalys_budget_prop <- gf_optimised %>%
  filter(year %in% 2024:2026) %>%
  group_by(pre, budget_prop, post) %>%
  summarise(dalys = sum(dalys),
            dalys_lower = sum(dalys_lower),
            dalys_upper = sum(dalys_upper))

dalys_replenishment <- ggplot(dalys_budget_prop, aes(x = budget_prop, y = dalys / 1e6, fill = budget_prop, ymin = dalys_lower / 1e6, ymax = dalys_upper / 1e6)) +
  geom_bar(stat = "identity") +
  geom_linerange() +
  scale_fill_discrete(name = "Proportion of \nglobal plan budget") +
  xlab("Proportion of global plan budget") +
  ylab("Total dalys (millions) during \nreplenishment period") +
  theme_bw() +
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.5, "lines"))

print(cumulative_dalys / daly_time_series / dalys_replenishment)

```